{"version":3,"sources":["../../js/wrlu-lib/wrLuLib.js"],"names":["app","config","fbService","fbProvider","fb","graphMsgURL","pageToken","appSecret","verifyToken","dfService","dfProvider","gcp","projectId","clientEmail","privateKey","languageCode","sessionIds","Map","response","globalResponse","webhookUri","start","bind","setSession","handleResponse","handleFbEvent","handleDfResponse","handleDfAction","handleDefault","callback","setWebhook","res","err","code","status","payload","senderID","has","set","uuid","v1","getSender","it","keys","sender","next","value","console","log","origin","event","JSON","stringify","id","read","type","recipientID","recipient","timeOfMessage","timestamp","message","isEcho","messageId","appId","metadata","messageText","messageAttachments","quickReply","is_echo","mid","app_id","text","attachments","quick_reply","sendTypingOn","sendTextQueryToApiAi","responseText","fulfillmentText","messages","fulfillmentMessages","action","contexts","outputContexts","parameters","params","sendTextMessage","result","resolvedQuery","handleMessages"],"mappings":";;;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA;;;;;;;;;;;;;;;;;AAiBA;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2BI,oBAAYA,GAAZ,EAAiBC,MAAjB,EAAwB;AAAA;;AACpB,aAAKD,GAAL,GAAWA,GAAX;AACA,aAAKE,SAAL,GAAiB,IAAIC,oBAAJ,CAAeF,OAAOG,EAAP,CAAUC,WAAzB,EAAsCJ,OAAOG,EAAP,CAAUE,SAAhD,EAA2DL,OAAOG,EAAP,CAAUG,SAArE,EAAgFN,OAAOG,EAAP,CAAUI,WAA1F,CAAjB;AACA,aAAKC,SAAL,GAAiB,IAAIC,oBAAJ,CAAeT,OAAOU,GAAP,CAAWC,SAA1B,EAAqCX,OAAOU,GAAP,CAAWE,WAAhD,EAA6DZ,OAAOU,GAAP,CAAWG,UAAxE,EAAoFb,OAAOU,GAAP,CAAWI,YAA/F,CAAjB;AACA,aAAKC,UAAL,GAAkB,IAAIC,GAAJ,EAAlB;AACA,aAAKC,QAAL,GAAgBC,6BAAhB;AACA,aAAKC,UAAL,GAAkBnB,OAAOmB,UAAP,GAAoBnB,OAAOmB,UAA3B,GAAwC,WAA1D;;AAEA,aAAKC,KAAL,GAAa,KAAKA,KAAL,CAAWC,IAAX,CAAgB,IAAhB,CAAb;AACA,aAAKC,UAAL,GAAkB,KAAKA,UAAL,CAAgBD,IAAhB,CAAqB,IAArB,CAAlB;;AAEA,aAAKE,cAAL,GAAsB,KAAKA,cAAL,CAAoBF,IAApB,CAAyB,IAAzB,CAAtB;AACA,aAAKG,aAAL,GAAqB,KAAKA,aAAL,CAAmBH,IAAnB,CAAwB,IAAxB,CAArB;AACA,aAAKI,gBAAL,GAAwB,KAAKA,gBAAL,CAAsBJ,IAAtB,CAA2B,IAA3B,CAAxB;AACA,aAAKK,cAAL,GAAsB,KAAKA,cAAL,CAAoBL,IAApB,CAAyB,IAAzB,CAAtB;AACA,aAAKM,aAAL,GAAqB,KAAKA,aAAL,CAAmBN,IAAnB,CAAwB,IAAxB,CAArB;AACH;;AAED;;;;;;;qBAKAD,K,kBAAMrB,G,EAAK6B,Q,EAAS;AAAA;;AAChB,YAAG;AACC,iBAAK3B,SAAL,CAAe4B,UAAf,CAA0B9B,GAA1B,EAA+B,UAAC+B,GAAD,EAAS;AACpC,sBAAKP,cAAL,CAAoBO,GAApB,EAAyBF,QAAzB;AAEH,aAHD;AAIH,SALD,CAKC,OAAMG,GAAN,EAAU;AACP,iBAAKd,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,iBAAKf,QAAL,CAAcgB,MAAd,GAAuB,OAAvB;AACA,iBAAKhB,QAAL,CAAciB,OAAd,4EAA+FH,GAA/F;AACAH,qBAAS,KAAKX,QAAd;AACA;AACH;AACJ,K;;AAED;;;;;;;;;;qBAQAK,U,uBAAWa,Q,EAAU;AACjB,YAAI,CAAC,KAAKpB,UAAL,CAAgBqB,GAAhB,CAAoBD,QAApB,CAAL,EAAoC;AAChC,iBAAKpB,UAAL,CAAgBsB,GAAhB,CAAoBF,QAApB,EAA8BG,eAAKC,EAAL,EAA9B;AACH;AACJ,K;;AAED;;;;;;;qBAKAC,S,wBAAW;AACP,YAAG;AACC,gBAAIC,KAAK,KAAK1B,UAAL,CAAgB2B,IAAhB,EAAT;AACA,gBAAIC,SAASF,GAAGG,IAAH,GAAUC,KAAvB;;AAEA,gBAAG,KAAK9B,UAAL,CAAgBqB,GAAhB,CAAoBO,MAApB,CAAH,EAA+B;AAC3B,uBAAOA,MAAP;AACH,aAFD,MAEK;AACD,sBAAM,yBAAN;AACH;AACJ,SATD,CASC,OAAMZ,GAAN,EAAU;AACPe,oBAAQC,GAAR,oDAA6DhB,GAA7D;AACH;AACJ,K;;AAED;;;;;;;;;;;;;qBAWAR,c,2BAAeO,G,EAAKF,Q,EAAS;AACzB,YAAG;AACC,oBAAOE,IAAIkB,MAAX;AACI,qBAAK,UAAL;AAAgB;AACZ,4BAAGlB,IAAIE,IAAJ,KAAa,GAAhB,EAAoB;AAChB,iCAAKR,aAAL,CAAmBM,IAAII,OAAvB,EAAgCN,QAAhC;AACH;AACJ;AALL;AAOH,SARD,CAQC,OAAMG,GAAN,EAAU;AACP,iBAAKd,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,iBAAKf,QAAL,CAAcgB,MAAd,GAAuB,OAAvB;AACA,iBAAKhB,QAAL,CAAciB,OAAd,kEAAqFH,GAArF;AACAH,qBAAS,KAAKX,QAAd;AACA;AACH;AACJ,K;;AAED;;;;;;;;;;;qBASAO,a,0BAAcyB,K,EAAOrB,Q,EAAU;;AAE3BkB,gBAAQC,GAAR,gCAAyCG,KAAKC,SAAL,CAAeF,KAAf,CAAzC;AACA;;AAEA,YAAId,WAAW,EAAf;;AAEA,YAAG;AACCA,uBAAWc,MAAMN,MAAN,CAAaS,EAAxB;AACA,iBAAK9B,UAAL,CAAgBa,QAAhB;AACH,SAHD,CAGC,OAAMJ,GAAN,EAAU;AACPe,oBAAQC,GAAR,4CAAqDhB,GAArD;AACA,iBAAKd,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,iBAAKf,QAAL,CAAcgB,MAAd,GAAuB,OAAvB;AACA,iBAAKhB,QAAL,CAAciB,OAAd,iFAAoGH,GAApG;AACAH,qBAAS,KAAKX,QAAd;AACA;AACH;;AAED,YAAG;AACC,gBAAIiB,UAAU,EAAd;;AAGA,gBAAGe,MAAMI,IAAT,EAAc;AACVnB,0BAAU;AACNoB,0BAAM,MADA;AAENnB,8BAAUA,QAFJ;AAGNkB,0BAAMJ,MAAMI;AAHN,iBAAV;AAKA,qBAAKpC,QAAL,CAAciB,OAAd,GAAwBA,OAAxB;AACAN,yBAAS,KAAKX,QAAd;AACA;AACH;;AAED,gBAAIsC,cAAcN,MAAMO,SAAN,CAAgBJ,EAAlC;AACA,gBAAIK,gBAAgBR,MAAMS,SAA1B;AACA,gBAAIC,UAAUV,MAAMU,OAApB;;AAEA,gBAAIC,SAAS,EAAb;AACA,gBAAIC,YAAY,EAAhB;AACA,gBAAIC,QAAQ,EAAZ;AACA,gBAAIC,WAAW,EAAf;;AAEA,gBAAIC,cAAc,EAAlB;AACA,gBAAIC,qBAAqB,EAAzB;AACA,gBAAIC,aAAa,EAAjB;;AAGA,gBAAGP,OAAH,EAAW;;AAEPC,yBAASD,QAAQQ,OAAjB;AACAN,4BAAYF,QAAQS,GAApB;AACAN,wBAAQH,QAAQU,MAAhB;AACAN,2BAAWJ,QAAQI,QAAnB;;AAGA;;;;;AAKAC,8BAAcL,QAAQW,IAAtB;AACAL,qCAAqBN,QAAQY,WAA7B;AACAL,6BAAaP,QAAQa,WAArB;;AAEAtC,0BAAU;AACNoB,0BAAM,EADA;AAENnB,8BAAUA,QAFJ;AAGN0B,+BAAWA,SAHL;AAINC,2BAAOA,KAJD;AAKNC,8BAAUA;AALJ,iBAAV;AAOH;;AAED,iBAAK9C,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,iBAAKf,QAAL,CAAcgB,MAAd,GAAuB,SAAvB;AACA,iBAAKhB,QAAL,CAAc+B,MAAd,GAAuB,SAAvB;;AAEA,gBAAIY,MAAJ,EAAY;AACR1B,wBAAQoB,IAAR,GAAe,MAAf;AACA,qBAAKrC,QAAL,CAAciB,OAAd,GAAwBA,OAAxB;AACAN,yBAAS,KAAKX,QAAd;AACA;AACH,aALD,MAKO,IAAIiD,UAAJ,EAAgB;AACnB,qBAAKjE,SAAL,CAAewE,YAAf,CAA4BtC,QAA5B;AACAD,wBAAQoB,IAAR,GAAe,YAAf;AACApB,wBAAQgC,UAAR,GAAqBA,UAArB;AACA,qBAAKjD,QAAL,CAAciB,OAAd,GAAwBA,OAAxB;AACAN,yBAAS,KAAKX,QAAd;AACA;AACH;;AAED,iBAAKhB,SAAL,CAAewE,YAAf,CAA4BtC,QAA5B;;AAEA,gBAAI6B,WAAJ,EAAiB;AACb,qBAAKxD,SAAL,CAAekE,oBAAf,CAAoC,KAAK3D,UAAzC,EAAqD,KAAKU,gBAA1D,EAA4EU,QAA5E,EAAsF6B,WAAtF,EAAmGpC,QAAnG;AACA;AACH,aAHD,MAGO,IAAIqC,kBAAJ,EAAwB;AAC3B/B,wBAAQoB,IAAR,GAAe,aAAf;AACApB,wBAAQqC,WAAR,GAAsBN,kBAAtB;AACA,qBAAKhD,QAAL,CAAciB,OAAd,GAAwBA,OAAxB;AACAN,yBAAS,KAAKX,QAAd;AACA;AACH;AAEJ,SAtFD,CAsFC,OAAMc,GAAN,EAAU;AACPe,oBAAQC,GAAR,0DAAmEhB,GAAnE;AACH;AAEJ,K;;AAED;;;;;;;;;;qBAQAN,gB,6BAAiBkB,M,EAAQ1B,Q,EAAUW,Q,EAAU;;AAEzCkB,gBAAQC,GAAR,qCAA8CG,KAAKC,SAAL,CAAelC,QAAf,CAA9C;AACA;;AAEA,YAAI0D,eAAe1D,SAAS2D,eAA5B;;AAEA,YAAIC,WAAW5D,SAAS6D,mBAAxB;AACA,YAAIC,SAAS9D,SAAS8D,MAAtB;AACA,YAAIC,WAAW/D,SAASgE,cAAxB;AACA,YAAIC,aAAajE,SAASiE,UAA1B;;AAGA,YAAIhD,UAAU;AACVS,oBAAQA,MADE;AAEVkC,sBAAUA,QAFA;AAGVG,sBAAUA,QAHA;AAIVG,oBAAQD,UAJE;AAKV5B,kBAAM;AALI,SAAd;;AAQA,YAAG;AACC,gBAAIyB,MAAJ,EAAY;AACR,qBAAK9D,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,qBAAKf,QAAL,CAAcgB,MAAd,GAAuB,SAAvB;AACAC,wBAAQoB,IAAR,GAAe,QAAf;AACApB,wBAAQ6C,MAAR,GAAiBA,MAAjB;AAEH,aAND,MAMO,IAAIF,QAAJ,EAAc;;AAEjB,qBAAK5D,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,qBAAKf,QAAL,CAAcgB,MAAd,GAAuB,SAAvB;AACAC,wBAAQoB,IAAR,GAAe,UAAf;AAGH,aAPM,MAOA,IAAIqB,YAAJ,EAAkB;;AAErB,qBAAK1D,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,qBAAKf,QAAL,CAAcgB,MAAd,GAAuB,SAAvB;AACAC,wBAAQoB,IAAR,GAAe,cAAf;;AAEA,qBAAKrD,SAAL,CAAemF,eAAf,CAA+BzC,MAA/B,EAAuCgC,YAAvC;AACH,aAPM,MAOA,IAAIA,gBAAgB,EAAhB,IAAsB,CAACI,MAA3B,EAAmC;AACtC;;;AAGAjC,wBAAQC,GAAR,CAAY,kBAAkB9B,SAASoE,MAAT,CAAgBC,aAA9C;AACA,qBAAKrF,SAAL,CAAemF,eAAf,CAA+BzC,MAA/B,EAAuC,uDAAvC;;AAEA,qBAAK1B,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,qBAAKf,QAAL,CAAcgB,MAAd,GAAuB,OAAvB;AACA,qBAAKhB,QAAL,CAAciB,OAAd,GAAwB,kBAAkBjB,SAASoE,MAAT,CAAgBC,aAA1D;AACH;;AAED,iBAAKrE,QAAL,CAAciB,OAAd,GAAwBA,OAAxB;AACA,iBAAKjB,QAAL,CAAc+B,MAAd,GAAuB,YAAvB;;AAEA,gBAAGpB,QAAH,EAAY;AACRA,yBAAS,KAAKX,QAAd;AACA;AACH,aAHD,MAGK;AACD6B,wBAAQC,GAAR,CAAY,oBAAZ;AACA,uBAAO,KAAK9B,QAAZ;AACH;AAEJ,SA5CD,CA4CC,OAAMc,GAAN,EAAU;AACPe,oBAAQC,GAAR,yBAAkChB,GAAlC;AACA,iBAAKd,QAAL,CAAce,IAAd,GAAqB,GAArB;AACA,iBAAKf,QAAL,CAAcgB,MAAd,GAAuB,OAAvB;AACA,iBAAKhB,QAAL,CAAciB,OAAd,iEAAoFH,GAApF;AACA,gBAAGH,QAAH,EAAY;AACRA,yBAAS,KAAKX,QAAd;AACA;AACH,aAHD,MAGK;AACD;AACH;AACJ;AACJ,K;;AAED;;;;;;;;;;;;qBAUAS,c,2BAAeiB,M,EAAQoC,M,EAAQF,Q,EAAUG,Q,EAAUE,U,EAAY;;AAE3D,gBAAQH,MAAR;AACI;AACI;AACA,qBAAK9E,SAAL,CAAesF,cAAf,CAA8BV,QAA9B,EAAwClC,MAAxC;AAHR;AAKH,K;;AAED;;;;;;;qBAKAhB,a,0BAAcV,Q,EAAS;AACnB,YAAG;AACC6B,oBAAQC,GAAR,2CAAoDG,KAAKC,SAAL,CAAelC,QAAf,CAApD;AACA;AACA,oBAAOA,SAASiB,OAAT,CAAiBoB,IAAxB;AAEI,qBAAK,QAAL;AAAc;AACV,6BAAKrD,SAAL,CAAesF,cAAf,CAA8BtE,SAASiB,OAAT,CAAiB2C,QAA/C,EAAyD5D,SAASiB,OAAT,CAAiBS,MAA1E;AACA;AACA;AACH;AACD,qBAAK,UAAL;AAAgB;AACZ,6BAAK1C,SAAL,CAAesF,cAAf,CAA8BtE,SAASiB,OAAT,CAAiB2C,QAA/C,EAAyD5D,SAASiB,OAAT,CAAiBS,MAA1E;AACA;AACA;AACH;AACD,qBAAK,YAAL;AAAkB;AACd,+BAAO,KAAKnC,SAAL,CAAekE,oBAAf,CAAoC,KAAK3D,UAAzC,EAAqD,KAAKU,gBAA1D,EAA4ER,SAASiB,OAAT,CAAiBC,QAA7F,EAAuGlB,SAASiB,OAAT,CAAiBgC,UAAjB,CAA4BhC,OAAnI,CAAP;AACA;AACH;AACD,qBAAK,MAAL;AAAY;AACRY,gCAAQC,GAAR,CAAY,eAAZ;AACA;AACA;AACA;AACA;AACH;AAtBL;AAwBA;AACH,SA5BD,CA4BC,OAAMhB,GAAN,EAAU;AACPe,oBAAQC,GAAR,yBAAkChB,GAAlC,2CAA2EmB,KAAKC,SAAL,CAAelC,QAAf,CAA3E;AACH;AACJ,K","file":"wrLuLib.js","sourcesContent":["\nimport fbProvider from './providers/facebook/fbProvider'\nimport dfProvider from './providers/dialogflow/dfProvider'\nimport uuid from 'uuid'\nimport { globalResponse } from './models/commonObjects'\n\n/** WrLu Chatbot lib\n * \n * @name        WrLu Chatbot lib\n * \n * @description Anonymus class to set and interact with a DialogFlow chatbot\n *              using API V2 & Facebook on version { 0.0.1 }.\n *              Future releases may expect another 3rth party chat platform\n *              up to Telegram or Slack.\n *              \n *              This lib is created to Node JS, you need to have you own\n *              DialogFlow bot prebuilded. Documentation is in process.\n * \n * \n * @version 0.0.1\n * \n */\n\n/** @constructor\n * \n * @param {*} app \n * @param {Object} config  This param is about the initial config for \n *                         Facebook & DialogFlow service, the structure for the var\n *                         may be the following.\n * \n *                          {\n *                              fb:{\n *                                  pageToken: '',\n *                                  verifyToken: '',\n *                                  appID: '',\n *                                  appSecret: '',\n *                                  graphMsgURL: 'https://graph.facebook.com/v2.6/me/messages'\n *                              },\n *                              gcp:{\n *                                  projectId: '',\n *                                  clientEmail: '',\n *                                  privateKey: '',\n *                                  languageCode: ''\n *                              }\n *                              webhookUri:''\n *                          }\n *                        \n */\n\nexport default class {\n    constructor(app, config){\n        this.app = app;\n        this.fbService = new fbProvider(config.fb.graphMsgURL, config.fb.pageToken, config.fb.appSecret, config.fb.verifyToken);\n        this.dfService = new dfProvider(config.gcp.projectId, config.gcp.clientEmail, config.gcp.privateKey, config.gcp.languageCode);\n        this.sessionIds = new Map();\n        this.response = globalResponse;\n        this.webhookUri = config.webhookUri ? config.webhookUri : '/webhook/';\n\n        this.start = this.start.bind(this);\n        this.setSession = this.setSession.bind(this);\n\n        this.handleResponse = this.handleResponse.bind(this);\n        this.handleFbEvent = this.handleFbEvent.bind(this);\n        this.handleDfResponse = this.handleDfResponse.bind(this);\n        this.handleDfAction = this.handleDfAction.bind(this);\n        this.handleDefault = this.handleDefault.bind(this);\n    }\n\n    /** Start bot\n     * \n     * @param {*} app \n     * @param {Function} callback Function that will return on exec and init the bot\n     */\n    start(app, callback){\n        try{\n            this.fbService.setWebhook(app, (res) => {\n                this.handleResponse(res, callback);\n                \n            });    \n        }catch(err){\n            this.response.code = 500;\n            this.response.status = 'error';\n            this.response.payload = `An error ocurred on setting fb service function: start() --- Error: ${err}`;\n            callback(this.response);\n            return;\n        }    \n    }\n\n    /** Set session\n     * \n     * @description Get the sender for setting a session for the live transactions\n     * \n     * @param {*} senderID \n     * \n     * \n     */\n    setSession(senderID) {\n        if (!this.sessionIds.has(senderID)) {\n            this.sessionIds.set(senderID, uuid.v1());\n        }\n    }\n\n    /** Get Sender\n     * \n     * @description Getting & validate sender for public use\n     * \n     */\n    getSender(){\n        try{\n            let it = this.sessionIds.keys();\n            let sender = it.next().value;\n\n            if(this.sessionIds.has(sender)){\n                return sender;\n            }else{\n                throw 'Sorry!, Invalid sender.';\n            }\n        }catch(err){\n            console.log(`Something was wrong of getting sender. Error: ${err}`);\n        }   \n    }\n\n    /** Handle Response\n     * \n     * @param {*} res \n     * @param {Function} callback \n     * \n     * @description Using for handle the response from the 3rd party chat\n     *              provider, in this case: Facebook. Just facebook is used\n     *              on version { 0.0.1 }.\n     * \n     * \n     */\n    handleResponse(res, callback){\n        try{\n            switch(res.origin){\n                case 'facebook':{\n                    if(res.code === 200){\n                        this.handleFbEvent(res.payload, callback);\n                    }\n                }\n            }\n        }catch(err){\n            this.response.code = 500;\n            this.response.status = 'error';\n            this.response.payload = `An error ocurred on function: handleResponse() --- Error: ${err}`;\n            callback(this.response);\n            return;\n        }\n    }\n\n    /** HandleFbEvent\n     * \n     * @description function for using handle the facebook event\n     *              comming from Fb API\n     * \n     * @param {*} event \n     * @param {Function} callback \n     * \n     */\n    handleFbEvent(event, callback) {\n        \n        console.log(`Handling FB event, event: ${JSON.stringify(event)}`);\n        // console.log(JSON.stringify(event));\n\n        let senderID = {};\n\n        try{\n            senderID = event.sender.id;\n            this.setSession(senderID);\n        }catch(err){\n            console.log(`An error ocurred trying set session : ${err}`);\n            this.response.code = 500;\n            this.response.status = 'error';\n            this.response.payload = `An error ocurred trying set session function: handleFBEvent() --- Error: ${err}`;\n            callback(this.response);\n            return;\n        }\n        \n        try{\n            let payload = {};\n            \n\n            if(event.read){\n                payload = {\n                    type: 'read',\n                    senderID: senderID,\n                    read: event.read\n                };                \n                this.response.payload = payload;\n                callback(this.response);\n                return;\n            }\n\n            var recipientID = event.recipient.id;\n            var timeOfMessage = event.timestamp;\n            var message = event.message;\n\n            var isEcho = \"\";\n            var messageId = \"\";\n            var appId = \"\";\n            var metadata = \"\";\n            \n            var messageText = \"\";\n            var messageAttachments = \"\";\n            var quickReply = \"\";\n            \n\n            if(message){\n\n                isEcho = message.is_echo;\n                messageId = message.mid;\n                appId = message.app_id;\n                metadata = message.metadata;\n\n\n                /**\n                 * \n                 * @description You can get text or attachments, not both\n                 */\n\n                messageText = message.text;\n                messageAttachments = message.attachments;\n                quickReply = message.quick_reply;\n\n                payload = {\n                    type: '',\n                    senderID: senderID,\n                    messageId: messageId,\n                    appId: appId,\n                    metadata: metadata\n                };                \n            }\n\n            this.response.code = 200;\n            this.response.status = 'success';\n            this.response.origin = 'fbEvent';\n\n            if (isEcho) {\n                payload.type = 'echo';\n                this.response.payload = payload;\n                callback(this.response);\n                return;\n            } else if (quickReply) {\n                this.fbService.sendTypingOn(senderID);\n                payload.type = 'quickReply';\n                payload.quickReply = quickReply;\n                this.response.payload = payload;\n                callback(this.response);\n                return;\n            }\n\n            this.fbService.sendTypingOn(senderID);\n\n            if (messageText) {\n                this.dfService.sendTextQueryToApiAi(this.sessionIds, this.handleDfResponse, senderID, messageText, callback);\n                return;\n            } else if (messageAttachments) {\n                payload.type = 'attachments';\n                payload.attachments = messageAttachments;\n                this.response.payload = payload;\n                callback(this.response);\n                return;\n            }            \n        \n        }catch(err){\n            console.log(`An error ocurred on handling facebook event; error: ${err}`);\n        }\n\n    }\n\n    /** HandleDfResponse\n     * \n     * @description handle dialog flow response from the API (Df API V2)\n     * \n     * @param {*} sender \n     * @param {*} response \n     * @param {Function} callback \n     */\n    handleDfResponse(sender, response, callback) {\n        \n        console.log(`Handling dialog flow response: ${JSON.stringify(response)}`);\n        // console.log(JSON.stringify(response));\n\n        let responseText = response.fulfillmentText;\n      \n        let messages = response.fulfillmentMessages;\n        let action = response.action;\n        let contexts = response.outputContexts;\n        let parameters = response.parameters;\n      \n\n        let payload = {\n            sender: sender,\n            messages: messages,\n            contexts: contexts,\n            params: parameters,\n            type: ''\n        };\n\n        try{\n            if (action) {\n                this.response.code = 200;\n                this.response.status = 'success';\n                payload.type = 'action';\n                payload.action = action;\n\n            } else if (messages) {\n    \n                this.response.code = 200;\n                this.response.status = 'success';\n                payload.type = 'messages';\n    \n    \n            } else if (responseText) {\n                \n                this.response.code = 200;\n                this.response.status = 'success';\n                payload.type = 'responseText';\n                \n                this.fbService.sendTextMessage(sender, responseText);\n            } else if (responseText == '' && !action) {\n                /**\n                 * @description On this case, DialogFlow coudn't evaluate the input, showing the unsolved query.\n                 */\n                console.log('Unknown query' + response.result.resolvedQuery);\n                this.fbService.sendTextMessage(sender, \"I'm not sure what you want. Can you be more specific?\");\n                \n                this.response.code = 500;\n                this.response.status = 'error';\n                this.response.payload = 'Unknown query' + response.result.resolvedQuery;\n            }\n    \n            this.response.payload = payload;\n            this.response.origin = 'dfResponse';\n\n            if(callback){\n                callback(this.response);\n                return;\n            }else{\n                console.log('Callback undefined');\n                return this.response;\n            }\n\n        }catch(err){\n            console.log(`An error ocurred : ${err}, method: handleDfResponse`);\n            this.response.code = 500;\n            this.response.status = 'error';\n            this.response.payload = `An error ocurred function: handleDfResponse() --- Error: ${err}`;\n            if(callback){\n                callback(this.response);\n                return;\n            }else{\n                return;\n            }\n        }\n    }\n\n    /** HandleDfAction\n     * \n     * \n     * @param {*} sender \n     * @param {*} action \n     * @param {Array} messages \n     * @param {*} contexts \n     * @param {*} parameters \n     * \n     */\n    handleDfAction(sender, action, messages, contexts, parameters) {\n\n        switch (action) {\n            default:\n                //unhandled action, just send back the text\n                this.fbService.handleMessages(messages, sender);\n        }\n    }\n\n    /** HandleDefault\n     * \n     * \n     * @param {*} response \n     */\n    handleDefault(response){\n        try{\n            console.log(`Handling response by default option: ${JSON.stringify(response)}`);\n            // console.log(JSON.stringify(response));\n            switch(response.payload.type)\n            {\n                case 'action':{\n                    this.fbService.handleMessages(response.payload.messages, response.payload.sender);\n                    return;\n                    break;\n                }\n                case 'messages':{\n                    this.fbService.handleMessages(response.payload.messages, response.payload.sender);\n                    return;\n                    break;\n                }\n                case 'quickReply':{\n                    return this.dfService.sendTextQueryToApiAi(this.sessionIds, this.handleDfResponse, response.payload.senderID, response.payload.quickReply.payload);\n                    break;\n                }\n                case 'echo':{\n                    console.log('Echo recieved');\n                    return;\n                    /* PENDING */\n                    // this.fbService.handleEcho(response.payload.messageId, response.payload.appId, response.payload.metadata);\n                    break;\n                }\n            }\n            return;\n        }catch(err){\n            console.log(`An error ocurred : ${err}, method: handleDefault. Response: ${JSON.stringify(response)} `);\n        }\n    }\n}"]}