{"version":3,"sources":["../js/app.js"],"names":["app","constants","fbService","FbProvider","fb","graphMsgURL","pageToken","appSecret","dfService","DfProvider","googleProjectId","post","req","res","data","body","console","log","JSON","stringify","object","entry","forEach","pageEntry","pageID","id","timeOfEvent","time","messaging","messagingEvent","optin","receivedAuthentication","message","receivedMessage","delivery","receivedDeliveryConfirmation","postback","receivedPostback","read","receivedMessageRead","account_linking","receivedAccountLink","sendStatus","event","senderID","sender","recipientID","recipient","timeOfMessage","timestamp","setSessionAndUser","isEcho","is_echo","messageId","mid","appId","app_id","metadata","messageText","text","messageAttachments","attachments","quickReply","quick_reply","handleEcho","handleQuickReply","sendTextQueryToApiAi","sessionIds","handleApiAiResponse","handleMessageAttachments","timeOfPostback","payload","sendFunNewsSubscribe","greetUserText","sendEventToApiAi","sendTextMessage","response","responseText","result","fulfillment","speech","responseData","messages","action","contexts","parameters","sendTypingOff","isDefined","length","type","timeoutInterval","previousType","cardTypes","timeout","i","setTimeout","handleCardMessages","bind","handleMessage","push","handleApiAiAction","facebook","err","userService","newsletterSettings","updated","colors","readUserColor","color","reply","updateUserColor","readAllColors","allColors","allColorsString","join","sendTypingOn","buttons","url","title","sendButtonMessage","name","phone_number","user_name","previous_job","years_of_experience","job_vacancy","replies","sendQuickReply","jobApplicationCreate"],"mappings":"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","file":"app.js","sourcesContent":["\n\n\nimport { constants } from './libs/config'\nimport express from 'express'\nimport bodyParser from 'body-parser'\nimport request from 'request'\nimport passport from 'passport'\nimport { Strategy } from 'passport-facebook'\nimport session from 'express-session'\nimport uuid from 'uuid'\n\nimport init from './libs/init'\nimport settings from './libs/settings'\n\nimport router from './routes/index'\n\nimport './models/facebookObjects'\nimport { Button } from './models/facebookObjects';\n\nimport { FbProvider } from './providers/facebook/fbProvider'\nimport { DfProvider } from './providers/dialogflow/dfProvider'\n\n\n\n\n\nconst app = express();\n\nsettings(app, constants);\nrouter(app);\n\n\ninit(app);\n\nlet fbService = new FbProvider(constants.fb.graphMsgURL, constants.fb.pageToken, constants.fb.appSecret);\nlet dfService = new DfProvider(constants.googleProjectId, fbService);\n\n\n/*\n * All callbacks for Messenger are POST-ed. They will be sent to the same\n * webhook. Be sure to subscribe your app to your page to receive callbacks\n * for your page.\n * https://developers.facebook.com/docs/messenger-platform/product-overview/setup#subscribe_app\n *\n */\napp.post('/webhook/', function (req, res) {\n\tvar data = req.body;\n\tconsole.log(JSON.stringify(data));\n\n\n\t// Make sure this is a page subscription\n\tif (data.object == 'page') {\n\n\t\t// Iterate over each entry\n\t\t// There may be multiple if batched\n\t\tdata.entry.forEach(function (pageEntry) {\n\t\t\tvar pageID = pageEntry.id;\n\t\t\tvar timeOfEvent = pageEntry.time;\n\t\t\t// Iterate over each messaging event\n\t\t\tpageEntry.messaging.forEach(function (messagingEvent) {\n\t\t\t\tif (messagingEvent.optin) {\n\t\t\t\t\tfbService.receivedAuthentication(messagingEvent);\n\t\t\t\t} else if (messagingEvent.message) {\n\t\t\t\t\treceivedMessage(messagingEvent);\n\t\t\t\t} else if (messagingEvent.delivery) {\n\t\t\t\t\tfbService.receivedDeliveryConfirmation(messagingEvent);\n\t\t\t\t} else if (messagingEvent.postback) {\n\t\t\t\t\treceivedPostback(messagingEvent);\n\t\t\t\t} else if (messagingEvent.read) {\n\t\t\t\t\tfbService.receivedMessageRead(messagingEvent);\n\t\t\t\t} else if (messagingEvent.account_linking) {\n\t\t\t\t\tfbService.receivedAccountLink(messagingEvent);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(\"Webhook received unknown messagingEvent: \", messagingEvent);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t// Assume all went well.\n\t\t// You must send back a 200, within 20 seconds\n\t\tres.sendStatus(200);\n\t}\n});\n\n\nfunction receivedMessage(event) {\n\n\tvar senderID = event.sender.id;\n\tvar recipientID = event.recipient.id;\n\tvar timeOfMessage = event.timestamp;\n\tvar message = event.message;\n\n\tsetSessionAndUser(senderID);\n\n\t//console.log(\"Received message for user %d and page %d at %d with message:\", senderID, recipientID, timeOfMessage);\n\t//console.log(JSON.stringify(message));\n\n\n\tvar isEcho = message.is_echo;\n\tvar messageId = message.mid;\n\tvar appId = message.app_id;\n\tvar metadata = message.metadata;\n\n\t// You may get a text or attachment but not both\n\tvar messageText = message.text;\n\tvar messageAttachments = message.attachments;\n\tvar quickReply = message.quick_reply;\n\n\tif (isEcho) {\n\t\tfbService.handleEcho(messageId, appId, metadata);\n\t\treturn;\n\t} else if (quickReply) {\n\t\thandleQuickReply(senderID, quickReply, messageId);\n\t\treturn;\n\t}\n\n\n\tif (messageText) {\n\t\t//send message to api.ai\n\t\tdfService.sendTextQueryToApiAi(sessionIds, handleApiAiResponse, senderID, messageText);\n\t} else if (messageAttachments) {\n\t\tfbService.handleMessageAttachments(messageAttachments, senderID);\n\t}\n}\n\n/*\n * Postback Event\n *\n * This event is called when a postback is tapped on a Structured Message.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/postback-received\n *\n */\nfunction receivedPostback(event) {\n\tvar senderID = event.sender.id;\n\tvar recipientID = event.recipient.id;\n\tvar timeOfPostback = event.timestamp;\n\n\t// The 'payload' param is a developer-defined field which is set in a postback\n\t// button for Structured Messages.\n\tvar payload = event.postback.payload;\n\n\tsetSessionAndUser(senderID);\n\n\tswitch (payload) {\n\t\tcase 'FUN_NEWS':\n\t\t\tsendFunNewsSubscribe(senderID);\n\t\t\tbreak;\n\t\tcase 'GET_STARTED':\n\t\t\tgreetUserText(senderID);\n\t\t\tbreak;\n\t\tcase 'JOB_APPLY':\n\t\t\t//get feedback with new jobs\n            dfService.sendEventToApiAi(sessionIds, handleApiAiResponse, senderID, \"JOB_OPENINGS\");\n\t\t\tbreak;\n\t\tcase 'CHAT':\n\t\t\t//user wants to chat\n\t\t\tfbService.sendTextMessage(senderID, \"I love chatting too. Do you have any other questions for me?\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t//unindentified payload\n\t\t\tfbService.sendTextMessage(senderID, \"I'm not sure what you want. Can you be more specific?\");\n\t\t\tbreak;\n\n\t}\n\n\tconsole.log(\"Received postback for user %d and page %d with payload '%s' \" +\n\t\t\"at %d\", senderID, recipientID, payload, timeOfPostback);\n\n}\n\n\nfunction handleApiAiResponse(sender, response) {\n\n\tlet responseText = response.result.fulfillment.speech;\n\tlet responseData = response.result.fulfillment.data;\n\tlet messages = response.result.fulfillment.messages;\n\tlet action = response.result.action;\n\tlet contexts = response.result.contexts;\n\tlet parameters = response.result.parameters;\n\n\tfbService.sendTypingOff(sender);\n\n\tif (isDefined(messages) && (messages.length == 1 && messages[0].type != 0 || messages.length > 1)) {\n\t\tlet timeoutInterval = 1100;\n\t\tlet previousType ;\n\t\tlet cardTypes = [];\n\t\tlet timeout = 0;\n\t\tfor (var i = 0; i < messages.length; i++) {\n\n\t\t\tif ( previousType == 1 && (messages[i].type != 1 || i == messages.length - 1)) {\n\n\t\t\t\ttimeout = (i - 1) * timeoutInterval;\n\t\t\t\tsetTimeout(fbService.handleCardMessages.bind(null, cardTypes, sender), timeout);\n\t\t\t\tcardTypes = [];\n\t\t\t\ttimeout = i * timeoutInterval;\n\t\t\t\tsetTimeout(fbService.handleMessage.bind(null, messages[i], sender), timeout);\n\t\t\t} else if ( messages[i].type == 1 && i == messages.length - 1) {\n\t\t\t\tcardTypes.push(messages[i]);\n                timeout = (i - 1) * timeoutInterval;\n                setTimeout(fbService.handleCardMessages.bind(null, cardTypes, sender), timeout);\n                cardTypes = [];\n            } else if ( messages[i].type == 1) {\n                cardTypes.push(messages[i]);\n\t\t\t} else {\n\t\t\t\ttimeout = i * timeoutInterval;\n\t\t\t\tsetTimeout(fbService.handleMessage.bind(null, messages[i], sender), timeout);\n\t\t\t}\n\n\t\t\tpreviousType = messages[i].type;\n\n\t\t}\n\n\t} else if (responseText == '' && !isDefined(action)) {\n\t\t//api ai could not evaluate input.\n\t\t//console.log('Unknown query' + response.result.resolvedQuery);\n\t\tfbService.sendTextMessage(sender, \"I'm not sure what you want. Can you be more specific?\");\n\t} else if (isDefined(action)) {\n\t\thandleApiAiAction(sender, action, responseText, contexts, parameters);\n\t} else if (isDefined(responseData) && isDefined(responseData.facebook)) {\n\t\ttry {\n\t\t\tfbService.sendTextMessage(sender, responseData.facebook);\n\t\t} catch (err) {\n\t\t\tfbService.sendTextMessage(sender, err.message);\n\t\t}\n\t} else if (isDefined(responseText)) {\n\t\tfbService.sendTextMessage(sender, responseText);\n\t}\n}\n\n\nfunction handleApiAiAction(sender, action, responseText, contexts, parameters) {\n\tswitch (action) {\n\t\tcase \"unsubscribe\":\n            userService.newsletterSettings(function(updated) {\n                if (updated) {\n                    fbService.sendTextMessage(sender, \"You're unsubscribed. You can always subscribe back!\");\n                } else {\n                    fbService.sendTextMessage(sender, \"Newsletter is not available at this moment.\" +\n                        \"Try again later!\");\n                }\n            }, 0, sender);\n\t\t\tbreak;\n        case \"buy.iphone\":\n            colors.readUserColor(function(color) {\n                    let reply;\n                    if (color === '') {\n                        reply = 'In what color would you like to have it?';\n                    } else {\n                        reply = `Would you like to order it in your favourite color ${color}?`;\n                    }\n\t\t\t\tfbService.sendTextMessage(sender, reply);\n\n                }, sender\n            )\n            break;\n        case \"iphone_colors.favourite\":\n            colors.updateUserColor(parameters['color'], sender);\n            let reply = `Oh, I like it, too. I'll remember that.`;\n\t\t\tfbService.sendTextMessage(sender, reply);\n\n            break;\n        case \"iphone-colors\":\n            colors.readAllColors(function (allColors) {\n                let allColorsString = allColors.join(', ');\n                let reply = `IPhone 8 is available in ${allColorsString}. What is your favourite color?`;\n\t\t\t\tfbService.sendTextMessage(sender, reply);\n            });\n\n            break;\n\t\tcase \"faq-delivery\":\n\t\t\tfbService.sendTextMessage(sender, responseText);\n\t\t\tfbService.sendTypingOn(sender);\n\n\t\t\t//ask what user wants to do next\n\t\t\tsetTimeout(function() {\n\t\t\t\tlet buttons = [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype:\"web_url\",\n\t\t\t\t\t\turl:\"https://www.myapple.com/track_order\",\n\t\t\t\t\t\ttitle:\"Track my order\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype:\"phone_number\",\n\t\t\t\t\t\ttitle:\"Call us\",\n\t\t\t\t\t\tpayload:\"+16505551234\",\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttype:\"postback\",\n\t\t\t\t\t\ttitle:\"Keep on Chatting\",\n\t\t\t\t\t\tpayload:\"CHAT\"\n\t\t\t\t\t}\n\t\t\t\t];\n\n\t\t\t\tfbService.sendButtonMessage(sender, \"What would you like to do next?\", buttons);\n\t\t\t}, 3000)\n\n\t\t\tbreak;\n\t\tcase \"detailed-application\":\n\t\t\tif (isDefined(contexts[0]) &&\n\t\t\t\t(contexts[0].name == 'job_application' || contexts[0].name == 'job-application-details_dialog_context')\n\t\t\t\t&& contexts[0].parameters) {\n\t\t\t\tlet phone_number = (isDefined(contexts[0].parameters['phone-number'])\n\t\t\t\t&& contexts[0].parameters['phone-number']!= '') ? contexts[0].parameters['phone-number'] : '';\n\t\t\t\tlet user_name = (isDefined(contexts[0].parameters['user-name'])\n\t\t\t\t&& contexts[0].parameters['user-name']!= '') ? contexts[0].parameters['user-name'] : '';\n\t\t\t\tlet previous_job = (isDefined(contexts[0].parameters['previous-job'])\n\t\t\t\t&& contexts[0].parameters['previous-job']!= '') ? contexts[0].parameters['previous-job'] : '';\n\t\t\t\tlet years_of_experience = (isDefined(contexts[0].parameters['years-of-experience'])\n\t\t\t\t&& contexts[0].parameters['years-of-experience']!= '') ? contexts[0].parameters['years-of-experience'] : '';\n\t\t\t\tlet job_vacancy = (isDefined(contexts[0].parameters['job-vacancy'])\n\t\t\t\t&& contexts[0].parameters['job-vacancy']!= '') ? contexts[0].parameters['job-vacancy'] : '';\n\n\n\t\t\t\tif (phone_number == '' && user_name != '' && previous_job != '' && years_of_experience == '') {\n\n\t\t\t\t\tlet replies = [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\t\t\"title\":\"Less than 1 year\",\n\t\t\t\t\t\t\t\"payload\":\"Less than 1 year\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\t\t\"title\":\"Less than 10 years\",\n\t\t\t\t\t\t\t\"payload\":\"Less than 10 years\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\t\t\"title\":\"More than 10 years\",\n\t\t\t\t\t\t\t\"payload\":\"More than 10 years\"\n\t\t\t\t\t\t}\n\t\t\t\t\t];\n\t\t\t\t\tfbService.sendQuickReply(sender, responseText, replies);\n\t\t\t\t} else if (phone_number != '' && user_name != '' && previous_job != '' && years_of_experience != ''\n\t\t\t\t\t&& job_vacancy != '') {\n\t\t\t\t\tjobApplicationCreate(phone_number, user_name, previous_job, years_of_experience, job_vacancy);\n\t\t\t\t\tfbService.sendTextMessage(sender, responseText);\n\t\t\t\t} else {\n\t\t\t\t\tfbService.sendTextMessage(sender, responseText);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"job-enquiry\":\n\t\t\tlet replies = [\n\t\t\t\t{\n\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\"title\":\"Accountant\",\n\t\t\t\t\t\"payload\":\"Accountant\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\"title\":\"Sales\",\n\t\t\t\t\t\"payload\":\"Sales\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"content_type\":\"text\",\n\t\t\t\t\t\"title\":\"Not interested\",\n\t\t\t\t\t\"payload\":\"Not interested\"\n\t\t\t\t}\n\t\t\t];\n\t\t\tfbService.sendQuickReply(sender, responseText, replies);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t//unhandled action, just send back the text\n\t\t\t//console.log(\"send responce in handle actiongit: \" + responseText);\n\t\t\tfbService.sendTextMessage(sender, responseText);\n\t}\n}"]}